<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getMessaging, getToken, isSupported } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-messaging.js";

// >>> NOVA API KEY
const firebaseConfig = {
  apiKey: "AIzaSyAEQeIKc1MCrV8BJr0CH_mfjwCp1YiRC8s",
  authDomain: "agenda-4efa7.firebaseapp.com",
  projectId: "agenda-4efa7",
  storageBucket: "agenda-4efa7.appspot.com",
  messagingSenderId: "299659202964",
  appId: "1:299659202964:web:e358210feb4d7784f63f81"
};

const VAPID_KEY = "BDyyehg3466Bi3B_awzlWOcaXxwhRu1kC8O8KStXQrP6BWuAl2h_iZ8zkvl89-nOO1NqriRqlxPKvevxktY5SI8";
const SW_PATH = "/ProjetosRev0/firebase-messaging-sw.js";
const SW_SCOPE = "/ProjetosRev0/";

const btn = document.getElementById("btnConectar");
const statusTxt = document.getElementById("status");
const logEl = document.getElementById("log");

function log(...args) {
  const msg = args.join(" ");
  logEl.textContent += msg + "\n";
  console.log(...args);
}

const app = initializeApp(firebaseConfig);

btn.onclick = async () => {
  btn.disabled = true;
  btn.innerText = "SINCRONIZANDO...";
  statusTxt.innerText = "EM ANDAMENTO...";

  try {
    log("API KEY EM USO:", firebaseConfig.apiKey);

    const supported = await isSupported();
    if (!supported) throw new Error("FCM não suportado neste navegador");

    const permission = await Notification.requestPermission();
    if (permission !== "granted") throw new Error("Permissão negada");

    log("Registrando SW...");
    const reg = await navigator.serviceWorker.register(SW_PATH, { scope: SW_SCOPE });
    await navigator.serviceWorker.ready;

    const messaging = getMessaging(app);

    log("Gerando token...");
    const token = await getToken(messaging, {
      vapidKey: VAPID_KEY,
      serviceWorkerRegistration: reg
    });

    if (!token) throw new Error("Token vazio");

    statusTxt.innerText = "CONECTADO COM SUCESSO!";
    btn.style.background = "#4CAF50";
    btn.innerText = "CONEXÃO ATIVA";

    log("TOKEN:", token);
    alert("SUCESSO!");

  } catch (err) {
    statusTxt.innerText = "FALHA TÉCNICA";
    btn.disabled = false;
    btn.innerText = "TENTAR NOVAMENTE";
    log("ERRO:", err.message);
    alert(err.message);
  }
};
</script>