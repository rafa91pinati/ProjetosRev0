btn.onclick = async () => {
    try {
        btn.innerText = "TESTANDO ACESSO...";
        btn.disabled = true;

        // 1. Tenta o Login e mostra o resultado real no console
        const userCredential = await signInAnonymously(auth);
        const tokenIdentidade = await userCredential.user.getIdToken();
        console.log("CRACHÁ DE ACESSO:", tokenIdentidade); // Se aparecer um texto gigante aqui, o login está OK!

        // 2. Tenta o Alarme
        const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
        await navigator.serviceWorker.ready;

        const tokenAlarme = await getToken(messaging, { 
            vapidKey: 'BDyyehg3466Bi3B_awzlWOcaXxwhRu1kC8O8KStXQrP6BWuAl2h_iZ8zkvl89-nOO1NqriRqlxPKvevxktY5SI8',
            serviceWorkerRegistration: reg
        });

        if (tokenAlarme) {
            statusTxt.innerText = "CONECTADO COM SUCESSO!";
            btn.style.background = "#4CAF50";
            alert("SUCESSO TOTAL!");
        }
    } catch (err) {
        console.error("ERRO DETALHADO:", err.code, err.message);
        statusTxt.innerText = "FALHA TÉCNICA";
        alert("Erro fatal: " + err.message);
        btn.disabled = false;
    }
};