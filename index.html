<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conexão Inteligente - Alarme</title>
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: sans-serif;">
        <h1 id="status">Verificando Sistema...</h1>
        <p id="msg">Aguarde a validação do Google...</p>
        <button id="btnConectar" disabled style="padding: 20px; font-size: 1.2em; background: #ccc; cursor: not-allowed; border: none; border-radius: 10px;">
            AGUARDANDO LOGIN...
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-messaging.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDokOh2iwSG1L6NKna3DuM2jS6YiaphKKM",
            authDomain: "agenda-4efa7.firebaseapp.com",
            projectId: "agenda-4efa7",
            storageBucket: "agenda-4efa7.appspot.com",
            messagingSenderId: "299659202964",
            appId: "1:299659202964:web:e358210feb4d7784f63f81"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const messaging = getMessaging(app);

        const btn = document.getElementById('btnConectar');
        const statusTxt = document.getElementById('status');
        const msgTxt = document.getElementById('msg');

        // 1. INICIALIZAÇÃO PRIORITÁRIA: LOGIN ANÔNIMO
        // Resolve o erro "missing authentication credential" garantindo o login na entrada.
        signInAnonymously(auth).then(() => {
            console.log("Login anônimo iniciado...");
        }).catch(err => {
            statusTxt.innerText = "ERRO DE ACESSO";
            msgTxt.innerText = "Domínio não autorizado ou falha na rede.";
        });

        // 2. MONITOR DE CONEXÃO: SÓ ATIVA O BOTÃO QUANDO O LOGIN É CONFIRMADO
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Usuário Validado:", user.uid);
                statusTxt.innerText = "SISTEMA PRONTO";
                msgTxt.innerText = "O Google validou sua identidade.";
                btn.disabled = false;
                btn.innerText = "ATIVAR ALARME AGORA";
                btn.style.background = "#4CAF50";
                btn.style.color = "white";
                btn.style.cursor = "pointer";
            }
        });

        // 3. LÓGICA DE ATIVAÇÃO DO ALARME
        btn.onclick = async () => {
            try {
                btn.innerText = "CONECTANDO...";
                btn.disabled = true;

                // Pedir permissão do navegador
                const permission = await Notification.requestPermission();
                if (permission !== "granted") {
                    throw new Error("Permissão de notificação negada pelo navegador.");
                }

                // Registrar o Service Worker com o caminho da sua pasta no GitHub
                const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js', {
                    scope: './'
                });

                // Obter o Token com a CHAVE VAPID REAL do seu print
                const token = await getToken(messaging, { 
                    vapidKey: 'BDyyehg3466Bi3B_awzlWOcaXxwhRu1kC8O8KStXQrP6BWuAl2h_iZ8zkvl89-nOO1NqriRqlxPKvevxktY5SI8',
                    serviceWorkerRegistration: reg
                });

                if (token) {
                    statusTxt.innerText = "SISTEMA ATIVADO!";
                    msgTxt.innerText = "O alarme está conectado com sucesso.";
                    alert("SUCESSO! O alarme foi configurado.");
                    console.log("Token:", token);
                }

            } catch (err) {
                console.error("ERRO:", err);
                statusTxt.innerText = "FALHA TÉCNICA";
                msgTxt.innerText = err.message;
                btn.disabled = false;
                btn.innerText = "TENTAR NOVAMENTE";
                btn.style.background = "#f44336";
            }
        };
    </script>
</body>
</html>