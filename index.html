<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste de Conexão Alarme</title>
</head>
<body>
    <h1>Teste de Notificação</h1>
    <p>Status: <span id="status">Aguardando...</span></p>
    <button id="btnConectar" style="padding: 20px; font-size: 20px;">ATIVAR ALARME AGORA</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-messaging.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDokOh2iwSG1L6NKna3DuM2jS6YiaphKKM",
            authDomain: "agenda-4efa7.firebaseapp.com",
            projectId: "agenda-4efa7",
            storageBucket: "agenda-4efa7.appspot.com",
            messagingSenderId: "299659202964",
            appId: "1:299659202964:web:e358210feb4d7784f63f81"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const messaging = getMessaging(app);

        document.getElementById('btnConectar').onclick = async () => {
            const status = document.getElementById('status');
            status.innerText = "Iniciando...";

            try {
                // 1. Pedir Permissão
                const permission = await Notification.requestPermission();
                if (permission !== "granted") {
                    throw new Error("Permissão de notificação negada.");
                }

                // 2. Login Anônimo (Resolve erro de credencial ausente)
                // O domínio rafa91pinati.github.io já está autorizado no seu print
                await signInAnonymously(auth);
                status.innerText = "Autenticado. Registrando serviço...";

                // 3. Registrar o Service Worker manualmente (Resolve o erro 404 do GitHub subfolder)
                const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                status.innerText = "Serviço registrado. Obtendo Token...";

                // 4. Obter o Token com a CHAVE REAL do seu print (image_d77663.png)
                const token = await getToken(messaging, { 
                    vapidKey: 'BDyyehg3466Bi3B_awzlWOcaXxwhRu1kC8O8KStXQrP6BWuAl2h_iZ8zkvl89-nOO1NqriRqlxPKvevxktY5SI8',
                    serviceWorkerRegistration: registration
                });

                console.log("SUCESSO! Token gerado:", token);
                status.innerText = "CONECTADO COM SUCESSO!";
                alert("Conectado! Token: " + token);

            } catch (err) {
                console.error(err);
                status.innerText = "ERRO: " + err.message;
                alert("Falha: " + err.message);
            }
        };
    </script>
</body>
</html>