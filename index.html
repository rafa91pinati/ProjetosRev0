<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conector Agenda Inteligente</title>
</head>
<body style="font-family: sans-serif; text-align: center; padding: 40px;">

    <h1 id="status">SISTEMA AGUARDANDO</h1>
    <p id="detalhes">Clique no botão para forçar a conexão total.</p>
    
    <button id="btnConectar" style="padding: 20px; font-size: 1.2em; background: #2196F3; color: white; border: none; border-radius: 12px; cursor: pointer;">
        CONECTAR AGORA
    </button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-messaging.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDokOh2iwSG1L6NKna3DuM2jS6YiaphKKM",
            authDomain: "agenda-4efa7.firebaseapp.com",
            projectId: "agenda-4efa7",
            storageBucket: "agenda-4efa7.appspot.com",
            messagingSenderId: "299659202964",
            appId: "1:299659202964:web:e358210feb4d7784f63f81"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const messaging = getMessaging(app);

        document.getElementById('btnConectar').onclick = async () => {
            const btn = document.getElementById('btnConectar');
            const statusTxt = document.getElementById('status');
            const detalhesTxt = document.getElementById('detalhes');

            try {
                btn.innerText = "SINCRONIZANDO...";
                btn.disabled = true;

                // 1. LOGIN (Resolve 'missing authentication credential')
                await signInAnonymously(auth);
                console.log("Login validado.");

                // 2. REGISTRO (Garante o caminho da pasta ProjetosRev0)
                const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                
                // 3. A TRAVA DE ESPERA (Resolve 'no active Service Worker')
                // Isso obriga o código a esperar o navegador ativar o arquivo 100%
                await navigator.serviceWorker.ready; 

                // 4. GERAR TOKEN (Chave BDyyehg3... do seu print)
                const token = await getToken(messaging, { 
                    vapidKey: 'BDyyehg3466Bi3B_awzlWOcaXxwhRu1kC8O8KStXQrP6BWuAl2h_iZ8zkvl89-nOO1NqriRqlxPKvevxktY5SI8',
                    serviceWorkerRegistration: registration
                });

                if (token) {
                    statusTxt.innerText = "CONECTADO COM SUCESSO!";
                    btn.style.background = "#4CAF50";
                    btn.innerText = "CONEXÃO ATIVA";
                    alert("SUCESSO! Ponte estabelecida.");
                    console.log("Seu Token:", token);
                }

            } catch (err) {
                console.error(err);
                statusTxt.innerText = "FALHA TÉCNICA";
                detalhesTxt.innerText = "Erro: " + err.message;
                btn.disabled = false;
                btn.innerText = "TENTAR NOVAMENTE";
                btn.style.background = "#f44336";
            }
        };
    </script>
</body>
</html>