<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste de Conexão Alarme</title>
</head>
<body>
    <h1>Teste de Notificação</h1>
    <p>Status: <span id="status">Aguardando...</span></p>
    <button id="btnConectar" style="padding: 20px; font-size: 20px;">ATIVAR ALARME AGORA</button>

    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-messaging.js";

const firebaseConfig = {
    apiKey: "AIzaSyDokOh2iwSG1L6NKna3DuM2jS6YiaphKKM",
    authDomain: "agenda-4efa7.firebaseapp.com",
    projectId: "agenda-4efa7",
    storageBucket: "agenda-4efa7.appspot.com",
    messagingSenderId: "299659202964",
    appId: "1:299659202964:web:e358210feb4d7784f63f81"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const messaging = getMessaging(app);

// CHAVE PÚBLICA EXATA DO SEU PRINT
const CHAVE_VAPID_PUBLICA = "BDyyehg3466Bi3B_awzlWOcaXxwhRu1kC8O8KStXQrP6BWuAl2h_iZ8zkvl89-nOO1NqriRqlxPKvevxktY5SI8";

window.solicitarNotificacao = async () => {
    try {
        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
            alert("Você precisa permitir as notificações no navegador.");
            return;
        }

        // 1. FORÇAR O LOGIN ANÔNIMO E ESPERAR (Resolve 'missing credential')
        console.log("Autenticando...");
        const userCredential = await signInAnonymously(auth);
        console.log("Usuário autenticado:", userCredential.user.uid);

        // 2. REGISTRAR O SERVICE WORKER NA PASTA DO GITHUB (Resolve 404)
        const registration = await navigator.serviceWorker.register('/ProjetosRev0/firebase-messaging-sw.js', {
            scope: '/ProjetosRev0/'
        });
        console.log("Service Worker registrado na pasta ProjetosRev0");

        // 3. OBTER TOKEN USANDO A CHAVE DO SEU PRINT
        const token = await getToken(messaging, { 
            vapidKey: CHAVE_VAPID_PUBLICA,
            serviceWorkerRegistration: registration
        });

        if (token) {
            console.log("SUCESSO! Token obtido:", token);
            alert("Alarme conectado com sucesso!");
        } else {
            alert("Não foi possível gerar o token. Tente novamente.");
        }

    } catch (err) {
        console.error("ERRO DETALHADO:", err);
        // Tratamento específico para o erro de chave inválida
        if (err.message.includes("applicationServerKey")) {
            alert("Erro na Chave VAPID. Verifique se não há espaços extras.");
        } else {
            alert("Falha na conexão: " + err.message);
        }
    }
};
    </script>
</body>
</html>